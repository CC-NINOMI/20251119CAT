<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²“å’ªæ–¹å¡Š Catris - æœ€çµ‚å®Œç¾ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --panel-bg: #34495e;
            --accent: #f1c40f;
            --btn-color: #3498db;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: #ecf0f1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: none; /* ç¦æ­¢æ‰‹æ©Ÿä¸Šä¸‹æ»‘å‹•é é¢ */
            overflow: hidden;
        }

        /* åˆ†æ•¸èˆ‡ç­‰ç´šçœ‹æ¿ */
        .hud {
            display: flex;
            justify-content: space-between;
            width: 260px;
            background: var(--panel-bg);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            box-sizing: border-box;
        }
        .hud-item { text-align: center; }
        .hud-label { font-size: 12px; opacity: 0.7; letter-spacing: 1px; }
        .hud-value { font-size: 20px; font-weight: bold; color: var(--accent); }

        /* éŠæˆ²å€å¡Šå¤–æ¡† */
        #game-wrapper {
            position: relative;
            padding: 4px;
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
        }

        /* ç•«å¸ƒ */
        canvas {
            display: block;
            background-color: #111; /* ç¶²æ ¼èƒŒæ™¯è‰² */
        }

        /* é®ç½©å±¤ (é–‹å§‹/çµæŸ/æš«åœ) */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.88);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            border-radius: 4px;
            text-align: center;
        }
        .hidden { display: none !important; }

        h2 { margin: 0 0 15px; color: var(--accent); font-size: 28px; text-shadow: 2px 2px 0 #000; }
        p { color: #bdc3c7; margin-bottom: 20px; }

        button {
            background: #e67e22;
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px #d35400;
            transition: transform 0.1s;
        }
        button:active { transform: translateY(2px); box-shadow: 0 2px #d35400; }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls {
            width: 260px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* æ»‘æ¡¿æ¨£å¼ */
        .slider-box {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 20px;
        }
        input[type=range] {
            flex: 1;
            margin: 0 10px;
            -webkit-appearance: none;
            height: 8px;
            background: #bdc3c7;
            border-radius: 4px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px; height: 28px;
            background: #e74c3c;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 10px; }
        .btn-control {
            flex: 1;
            padding: 12px;
            background: var(--btn-color);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px #2980b9;
            user-select: none;
            font-weight: bold;
            font-size: 16px;
        }
        .btn-control:active { box-shadow: 0 2px #2980b9; transform: translateY(2px); }
        .btn-drop { background: #f39c12; box-shadow: 0 4px #d35400; }
        .btn-drop:active { box-shadow: 0 2px #d35400; }
        .btn-pause { background: #9b59b6; box-shadow: 0 4px #8e44ad; width: 100%; box-sizing: border-box; }
        .btn-pause:active { box-shadow: 0 2px #8e44ad; }

    </style>
</head>
<body>

    <!-- è³‡è¨Šé¢æ¿ -->
    <div class="hud">
        <div class="hud-item">
            <div class="hud-label">ç­‰ç´š (LV)</div>
            <div class="hud-value" id="level">1</div>
        </div>
        <div class="hud-item">
            <div class="hud-label">åˆ†æ•¸ (SCORE)</div>
            <div class="hud-value" id="score">0</div>
        </div>
    </div>

    <!-- éŠæˆ²ç•«é¢ -->
    <div id="game-wrapper">
        <!-- è¨­å®šé«˜åº¦ç‚º 480 (20æ ¼ x 24px) ç¢ºä¿åº•éƒ¨ä¸è¢«åˆ‡æ‰ -->
        <canvas id="tetris" width="240" height="480"></canvas>

        <!-- é–‹å§‹ç•«é¢ -->
        <div id="start-screen" class="overlay">
            <h2>ğŸ± è²“å’ªæ–¹å¡Š</h2>
            <p>æ‹–å‹•æ»‘æ¡¿ç§»å‹•ï¼Œé»æ“ŠæŒ‰éˆ•æ“ä½œ</p>
            <button onclick="startGame()">é–‹å§‹éŠæˆ² â–¶</button>
        </div>
        
        <!-- çµæŸç•«é¢ -->
        <div id="game-over" class="overlay hidden">
            <h2 style="color:#e74c3c">éŠæˆ²çµæŸ</h2>
            <p>æœ€çµ‚åˆ†æ•¸: <span id="final-score" style="color:#f1c40f; font-weight:bold;">0</span></p>
            <button onclick="startGame()">é‡æ–°é–‹å§‹ ğŸ”„</button>
        </div>

        <!-- æš«åœç•«é¢ -->
        <div id="pause-screen" class="overlay hidden">
            <h2>å·²æš«åœ</h2>
            <button onclick="togglePause()">ç¹¼çºŒéŠæˆ²</button>
        </div>
    </div>

    <!-- æ§åˆ¶å€ -->
    <div class="controls">
        <div class="slider-box">
            <span style="font-size:18px">ğŸ“</span>
            <input type="range" id="slider" min="0" max="9" value="4" step="1">
            <span style="font-size:18px">ğŸ“</span>
        </div>
        <div class="btn-group">
            <div class="btn-control" id="rotate-btn">ğŸ”„ æ—‹è½‰</div>
            <div class="btn-control btn-drop" id="drop-btn">â¬‡ï¸ åŠ é€Ÿ</div>
        </div>
        <div class="btn-control btn-pause" onclick="togglePause()">â¸ æš«åœéŠæˆ²</div>
    </div>

<script>
    // --- 1. åˆå§‹åŒ–èˆ‡å¸¸æ•¸ ---
    const canvas = document.getElementById('tetris');
    const ctx = canvas.getContext('2d');
    const ROW = 20;
    const COL = 10;
    const SQ = 24; // æ–¹å¡Šå¤§å°
    const VACANT = "#111"; // ç©ºæ ¼é¡è‰²

    // å½¢ç‹€è³‡æ–™
    const I = [ [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]], [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]], [[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]], [[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]] ];
    const J = [ [[1,0,0],[1,1,1],[0,0,0]], [[0,1,1],[0,1,0],[0,1,0]], [[0,0,0],[1,1,1],[0,0,1]], [[0,1,0],[0,1,0],[1,1,0]] ];
    const L = [ [[0,0,1],[1,1,1],[0,0,0]], [[0,1,0],[0,1,0],[0,1,1]], [[0,0,0],[1,1,1],[1,0,0]], [[1,1,0],[0,1,0],[0,1,0]] ];
    const O = [ [[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]] ];
    const S = [ [[0,1,1],[1,1,0],[0,0,0]], [[0,1,0],[0,1,1],[0,0,1]], [[0,0,0],[0,1,1],[1,1,0]], [[1,0,0],[1,1,0],[0,1,0]] ];
    const T = [ [[0,1,0],[1,1,1],[0,0,0]], [[0,1,0],[0,1,1],[0,1,0]], [[0,0,0],[1,1,1],[0,1,0]], [[0,1,0],[1,1,0],[0,1,0]] ];
    const Z = [ [[1,1,0],[0,1,1],[0,0,0]], [[0,0,1],[0,1,1],[0,1,0]], [[0,0,0],[1,1,0],[0,1,1]], [[0,1,0],[1,1,0],[1,0,0]] ];

    // è²“å’ªé¡è‰²å°æ‡‰
    const PIECES = [
        [Z, "#e57373"], // ç´…è²“
        [S, "#81c784"], // ç¶ è²“
        [T, "#ba68c8"], // ç´«è²“
        [O, "#ffd54f"], // é»ƒè²“
        [L, "#ffb74d"], // æ©˜è²“
        [I, "#4fc3f7"], // è—è²“
        [J, "#7986cb"]  // æ·±è—è²“
    ];

    // éŠæˆ²è®Šæ•¸
    let board = [];
    let score = 0;
    let level = 1;
    let gameRunning = false;
    let isPaused = false;
    let p; // ç•¶å‰æ–¹å¡Š
    let dropStart = Date.now();
    let animationFrame; // å‹•ç•«å¹€ ID
    let speed = 1000;

    // UI å…ƒç´ 
    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const slider = document.getElementById('slider');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over');
    const pauseScreen = document.getElementById('pause-screen');

    // --- 2. ç¹ªåœ–å‡½æ•¸ ---

    function createBoard() {
        for(let r=0; r<ROW; r++){
            board[r] = [];
            for(let c=0; c<COL; c++){
                board[r][c] = VACANT;
            }
        }
    }

    function drawSquare(x, y, color){
        if(color === VACANT){
            // ç¹ªè£½ç¶²æ ¼
            ctx.fillStyle = VACANT;
            ctx.fillRect(x*SQ, y*SQ, SQ, SQ);
            ctx.strokeStyle = "#222";
            ctx.strokeRect(x*SQ, y*SQ, SQ, SQ);
        } else {
            // ç¹ªè£½è²“å’ªæ–¹å¡Š
            ctx.fillStyle = color;
            ctx.fillRect(x*SQ, y*SQ, SQ, SQ);
            ctx.strokeStyle = "#fff"; // ç™½è‰²é‚Šæ¡†
            ctx.strokeRect(x*SQ, y*SQ, SQ, SQ);
            
            // è²“è‡‰ç´°ç¯€
            ctx.fillStyle = "rgba(255,255,255,0.6)";
            ctx.beginPath(); ctx.arc(x*SQ+7, y*SQ+10, 2, 0, Math.PI*2); ctx.fill(); // å·¦çœ¼
            ctx.beginPath(); ctx.arc(x*SQ+17, y*SQ+10, 2, 0, Math.PI*2); ctx.fill(); // å³çœ¼
            ctx.fillStyle = "pink";
            ctx.beginPath(); ctx.arc(x*SQ+12, y*SQ+15, 2, 0, Math.PI*2); ctx.fill(); // é¼»å­
        }
    }

    function draw(){
        // é‡ç¹ªæ•´å€‹ç•«é¢
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. ç•«å·²å›ºå®šçš„æ–¹å¡Š
        for(let r=0; r<ROW; r++){
            for(let c=0; c<COL; c++){
                drawSquare(c, r, board[r][c]);
            }
        }

        // 2. ç•«ç§»å‹•ä¸­çš„æ–¹å¡Š
        if(p){
            for(let r=0; r<p.activeTetromino.length; r++){
                for(let c=0; c<p.activeTetromino.length; c++){
                    if(p.activeTetromino[r][c]){
                        drawSquare(p.x + c, p.y + r, p.color);
                    }
                }
            }
        }
    }

    // --- 3. æ–¹å¡Šç‰©ä»¶èˆ‡é‚è¼¯ ---

    function Piece(tetromino, color){
        this.tetromino = tetromino;
        this.color = color;
        this.tetrominoN = 0;
        this.activeTetromino = this.tetromino[this.tetrominoN];
        this.x = 3;
        this.y = -2;
    }

    // â˜… é—œéµä¿®å¾©ï¼šè¨ˆç®—æ–¹å¡Šå·¦é‚Šçš„ç©ºç™½åç§»é‡
    Piece.prototype.getLeftOffset = function() {
        const matrix = this.activeTetromino;
        const N = matrix.length;
        for (let c = 0; c < N; c++) {
            for (let r = 0; r < N; r++) {
                if (matrix[r][c]) {
                    return c; // æ‰¾åˆ°ç¬¬ä¸€å€‹æœ‰å¯¦é«”çš„åˆ—
                }
            }
        }
        return 0;
    };

    // â˜… å–å¾—ã€Œè¦–è¦ºä¸Šã€çš„ X åº§æ¨™ (å°æ‡‰æ»‘æ¡¿)
    Piece.prototype.getVisualX = function() {
        return this.x + this.getLeftOffset();
    };

    Piece.prototype.collision = function(x, y, piece){
        for(let r=0; r<piece.length; r++){
            for(let c=0; c<piece.length; c++){
                if(!piece[r][c]) continue;
                let newX = this.x + c + x;
                let newY = this.y + r + y;
                
                if(newX < 0 || newX >= COL || newY >= ROW){
                    return true;
                }
                if(newY < 0) continue;
                if(board[newY][newX] !== VACANT){
                    return true;
                }
            }
        }
        return false;
    }

    Piece.prototype.lock = function(){
        for(let r=0; r<this.activeTetromino.length; r++){
            for(let c=0; c<this.activeTetromino.length; c++){
                if(!this.activeTetromino[r][c]) continue;
                // éŠæˆ²çµæŸæª¢æŸ¥
                if(this.y + r < 0){
                    gameRunning = false;
                    gameOverScreen.classList.remove('hidden');
                    document.getElementById('final-score').innerText = score;
                    return;
                }
                // å¯«å…¥ç›¤é¢
                board[this.y + r][this.x + c] = this.color;
            }
        }

        // æ¶ˆé™¤æ»¿è¡Œ
        let lines = 0;
        for(let r=0; r<ROW; r++){
            let isFull = true;
            for(let c=0; c<COL; c++){
                if(board[r][c] === VACANT) isFull = false;
            }
            if(isFull){
                lines++;
                for(let y=r; y>0; y--){
                    for(let c=0; c<COL; c++){
                        board[y][c] = board[y-1][c];
                    }
                }
                for(let c=0; c<COL; c++) board[0][c] = VACANT;
            }
        }

        // è¨ˆåˆ†
        if(lines > 0){
            score += lines * 100;
            scoreEl.innerText = score;
            level = Math.floor(score/500) + 1;
            levelEl.innerText = level;
            speed = Math.max(100, 1000 - (level-1)*100);
        }

        // ç”Ÿæˆæ–°æ–¹å¡Šä¸¦æ›´æ–°æ»‘æ¡¿
        p = randomPiece();
        slider.value = p.getVisualX();
    }

    Piece.prototype.moveDown = function(){
        if(!this.collision(0, 1, this.activeTetromino)){
            this.y++;
        } else {
            this.lock();
        }
        draw();
    }
    
    Piece.prototype.moveRight = function(){
        if(!this.collision(1, 0, this.activeTetromino)) {
            this.x++;
            slider.value = this.getVisualX(); // åŒæ­¥æ»‘æ¡¿
        }
    }
    
    Piece.prototype.moveLeft = function(){
        if(!this.collision(-1, 0, this.activeTetromino)) {
            this.x--;
            slider.value = this.getVisualX(); // åŒæ­¥æ»‘æ¡¿
        }
    }
    
    Piece.prototype.rotate = function(){
        let nextPattern = this.tetromino[(this.tetrominoN + 1) % this.tetromino.length];
        let kick = 0;
        if(this.collision(0,0,nextPattern)){
            if(this.x > COL/2) kick = -1; else kick = 1;
            // å˜—è©¦å¼·åŠ›è¸¢ç‰† (Wall Kick)
            if(this.collision(kick,0,nextPattern)) kick = (kick===-1) ? -2 : 2; 
        }
        if(!this.collision(kick,0,nextPattern)){
            this.x += kick;
            this.tetrominoN = (this.tetrominoN + 1) % this.tetromino.length;
            this.activeTetromino = this.tetromino[this.tetrominoN];
            slider.value = this.getVisualX(); // åŒæ­¥æ»‘æ¡¿
        }
    }

    function randomPiece(){
        let r = Math.floor(Math.random() * PIECES.length);
        return new Piece(PIECES[r][0], PIECES[r][1]);
    }

    // --- 4. éŠæˆ²å¾ªç’°æ§åˆ¶ ---

    function update(){
        if(!gameRunning || isPaused) return;
        
        let now = Date.now();
        let delta = now - dropStart;
        if(delta > speed){
            p.moveDown();
            dropStart = Date.now();
        }
        draw();
        animationFrame = requestAnimationFrame(update);
    }

    function startGame(){
        createBoard();
        score = 0; 
        level = 1;
        speed = 1000;
        scoreEl.innerText = "0";
        levelEl.innerText = "1";
        
        gameRunning = true;
        isPaused = false;
        
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        pauseScreen.classList.add('hidden');
        
        p = randomPiece();
        slider.value = p.getVisualX();
        dropStart = Date.now();
        
        if(animationFrame) cancelAnimationFrame(animationFrame);
        update();
    }

    function togglePause(){
        if(!gameRunning) return;
        isPaused = !isPaused;
        
        if(isPaused){
            pauseScreen.classList.remove('hidden');
        } else {
            pauseScreen.classList.add('hidden');
            dropStart = Date.now();
            update();
        }
    }

    // --- 5. äº‹ä»¶ç›£è½ ---

    // æ»‘æ¡¿æ“ä½œé‚è¼¯ (ä½¿ç”¨è¦–è¦ºåº§æ¨™æ ¡æ­£)
    slider.addEventListener('input', function(){
        if(!gameRunning || isPaused) return;
        let targetVisualX = parseInt(this.value);
        
        // å˜—è©¦å¾€å³è¿½
        while(p.getVisualX() < targetVisualX){
            if(!p.collision(1, 0, p.activeTetromino)) p.x++; else break;
        }
        // å˜—è©¦å¾€å·¦è¿½
        while(p.getVisualX() > targetVisualX){
            if(!p.collision(-1, 0, p.activeTetromino)) p.x--; else break;
        }
        draw();
    });

    document.getElementById('rotate-btn').addEventListener('click', ()=>{ if(gameRunning && !isPaused){ p.rotate(); draw(); } });
    document.getElementById('drop-btn').addEventListener('click', ()=>{ if(gameRunning && !isPaused){ p.moveDown(); draw(); } });

    // éµç›¤æ“ä½œ
    document.addEventListener('keydown', (e)=>{
        if(!gameRunning || isPaused) return;
        if(e.keyCode == 37) p.moveLeft();
        if(e.keyCode == 38) { p.rotate(); draw(); }
        if(e.keyCode == 39) p.moveRight();
        if(e.keyCode == 40) p.moveDown();
        if(e.keyCode == 32) togglePause(); // ç©ºç™½éµæš«åœ
    });

    // åˆå§‹ç•«é¢
    createBoard();
    draw();

</script>
</body>
</html>